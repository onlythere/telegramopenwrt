name: Build and Release Telegram OpenWrt Package

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: '–°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑?'
        type: boolean
        default: false
      version:
        description: '–í–µ—Ä—Å–∏—è –ø–∞–∫–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.0.0-1)'
        required: false
        default: '1.0.0-1'

jobs:
  build_package:
    name: Build Package
    runs-on: ubuntu-22.04

    outputs:
      package_file: ${{ steps.build.outputs.package_file }}
      package_version: ${{ steps.build.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=1.0.0-1" >> $GITHUB_OUTPUT
          fi

      - name: Install OpenWrt build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y binutils-multiarch build-essential

      - name: Create IPK package (OpenWrt compatible)
        id: build
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PACKAGE_NAME="telegramopenwrt"
          PACKAGE_FILE="${PACKAGE_NAME}_${VERSION}_aarch64_cortex-a53.ipk"
          
          echo "üî® –°–æ–∑–¥–∞–µ–º OpenWrt-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –ø–∞–∫–µ—Ç $PACKAGE_FILE"
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–∫–µ—Ç–∞
          mkdir -p package/data package/control
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –≤ data/
          echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã..."
          if [[ -d "etc" ]]; then
            cp -r etc package/data/
            echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω etc/"
          fi
          
          if [[ -d "sbin" ]]; then
            cp -r sbin package/data/
            echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω sbin/"
          fi
          
          if [[ -d "usr" ]]; then
            cp -r usr package/data/
            echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω usr/"
          fi
          
          # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
          DATA_SIZE=$(du -sb package/data | cut -f1)
          echo "üìä –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: $DATA_SIZE –±–∞–π—Ç"
          
          # –°–æ–∑–¥–∞–µ–º control —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenWrt
          cat > package/control/control << EOF
          Package: $PACKAGE_NAME
          Version: $VERSION
          Architecture: aarch64_cortex-a53
          Depends: curl, ca-certificates
          Section: utils
          Priority: optional
          Maintainer: onlythere
          License: GPL-2.0
          Source: github.com/onlythere/telegramopenwrt
          Installed-Size: $DATA_SIZE
          Description: Telegram Scripts for OpenWrt - Manage and get information on OpenWrt routers via Telegram bot
          EOF
          
          # –°–æ–∑–¥–∞–µ–º postinst script
          cat > package/control/postinst << 'EOF'
          #!/bin/sh
          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram OpenWrt..."
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
          chmod +x /sbin/* 2>/dev/null || true
          chmod +x /etc/init.d/* 2>/dev/null || true
          
          # –í–∫–ª—é—á–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
          [ -f "/etc/init.d/telegram_bot" ] && /etc/init.d/telegram_bot enable
          [ -f "/etc/init.d/lanports" ] && /etc/init.d/lanports enable
          [ -f "/etc/init.d/hosts_scan" ] && /etc/init.d/hosts_scan enable
          
          echo "ü§ñ Telegram OpenWrt —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
          echo "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ /etc/config/telegramopenwrt"
          EOF
          
          # –°–æ–∑–¥–∞–µ–º prerm script
          cat > package/control/prerm << 'EOF'
          #!/bin/sh
          [ -f "/etc/init.d/telegram_bot" ] && /etc/init.d/telegram_bot stop 2>/dev/null
          [ -f "/etc/init.d/lanports" ] && /etc/init.d/lanports stop 2>/dev/null
          [ -f "/etc/init.d/hosts_scan" ] && /etc/init.d/hosts_scan stop 2>/dev/null
          EOF
          
          chmod +x package/control/postinst package/control/prerm
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è OpenWrt
          echo "üì¶ –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤—ã..."
          cd package
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º GNU tar —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏
          tar --numeric-owner --owner=0 --group=0 -czf ../data.tar.gz data/
          tar --numeric-owner --owner=0 --group=0 -czf ../control.tar.gz control/
          echo "2.0" > ../debian-binary
          
          cd ..
          
          # –°–æ–∑–¥–∞–µ–º .ipk –∏—Å–ø–æ–ª—å–∑—É—è GNU ar (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å OpenWrt)
          echo "üîß –°–æ–±–∏—Ä–∞–µ–º IPK –ø–∞–∫–µ—Ç..."
          
          # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          rm -f "$PACKAGE_FILE"
          
          # –°–æ–∑–¥–∞–µ–º ar –∞—Ä—Ö–∏–≤ –≤ GNU —Ñ–æ—Ä–º–∞—Ç–µ (–Ω–µ BSD)
          /usr/bin/ar rcs "$PACKAGE_FILE" debian-binary control.tar.gz data.tar.gz
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [[ -f "$PACKAGE_FILE" ]]; then
            echo "‚úÖ –ü–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ:"
            ls -lh "$PACKAGE_FILE"
            echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            /usr/bin/ar t "$PACKAGE_FILE"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞:"
            file "$PACKAGE_FILE"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ ar
            echo "üìã –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞—Ä—Ö–∏–≤–∞:"
            head -c 20 "$PACKAGE_FILE" | hexdump -C
            
            echo "package_file=$PACKAGE_FILE" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–∫–µ—Ç–∞"
            exit 1
          fi

      - name: Test package with opkg-utils
        run: |
          PACKAGE_FILE="${{ steps.build.outputs.package_file }}"
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º opkg-utils –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
          sudo apt-get install -y python3-pip
          pip3 install --user opkg-utils || echo "opkg-utils –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–∫–µ—Ç
          echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º ar –∞—Ä—Ö–∏–≤
          /usr/bin/ar t "$PACKAGE_FILE"
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
          mkdir -p test_extract
          cd test_extract
          /usr/bin/ar x "../$PACKAGE_FILE"
          
          echo "–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          ls -la
          
          echo "debian-binary —Å–æ–¥–µ—Ä–∂–∏—Ç:"
          cat debian-binary
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º control.tar.gz:"
          tar -tzf control.tar.gz
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º data.tar.gz:"
          tar -tzf data.tar.gz | head -10
          
          cd ..
          echo "‚úÖ –ü–∞–∫–µ—Ç –ø—Ä–æ—à–µ–ª –±–∞–∑–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: telegramopenwrt-package-${{ steps.build.outputs.version }}
          path: ${{ steps.build.outputs.package_file }}
          if-no-files-found: error

  create_release:
    name: Create Release
    needs: build_package
    runs-on: ubuntu-22.04
    if: |
      needs.build_package.result == 'success' && (
        startsWith(github.ref, 'refs/tags/v') ||
        github.event.inputs.create_release == 'true'
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: telegramopenwrt-package-${{ needs.build_package.outputs.package_version }}
          path: ./packages

      - name: Create package repository files
        run: |
          cd packages
          PACKAGE_FILE="${{ needs.build_package.outputs.package_file }}"
          VERSION="${{ needs.build_package.outputs.package_version }}"
          
          # –°–æ–∑–¥–∞–µ–º Packages –∏–Ω–¥–µ–∫—Å
          echo "Package: telegramopenwrt" > Packages
          echo "Version: $VERSION" >> Packages
          echo "Depends: curl, ca-certificates" >> Packages
          echo "Section: utils" >> Packages
          echo "Architecture: aarch64_cortex-a53" >> Packages
          echo "Installed-Size: $(stat -c%s "$PACKAGE_FILE")" >> Packages
          echo "Filename: $PACKAGE_FILE" >> Packages
          echo "Size: $(stat -c%s "$PACKAGE_FILE")" >> Packages
          echo "SHA256sum: $(sha256sum "$PACKAGE_FILE" | cut -d' ' -f1)" >> Packages
          echo "Description: Telegram Scripts for OpenWrt" >> Packages
          echo "" >> Packages
          
          gzip -c Packages > Packages.gz

      - name: Get tag name
        id: tag_name
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            tag="v${{ needs.build_package.outputs.package_version }}"
            echo "tag=$tag" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_name.outputs.tag }}
          name: "Telegram OpenWrt Scripts ${{ steps.tag_name.outputs.tag }}"
          body: |
            ## ü§ñ Telegram OpenWrt Scripts ${{ steps.tag_name.outputs.tag }}
            
            ### üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
            ```bash
            # –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            echo 'src/gz telegramopenwrt https://github.com/onlythere/telegramopenwrt/releases/latest/download' >> /etc/opkg/customfeeds.conf
            
            # –û–±–Ω–æ–≤–∏—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            opkg update
            opkg install telegramopenwrt
            ```
            
            ### üì• –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
            ```bash
            # –°–∫–∞—á–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            wget -O telegramopenwrt.ipk https://github.com/onlythere/telegramopenwrt/releases/latest/download/${{ needs.build_package.outputs.package_file }}
            opkg install telegramopenwrt.ipk
            ```
            
            ### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —É [@BotFather](https://t.me/BotFather)
            2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `/etc/config/telegramopenwrt`
            3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: `/etc/init.d/telegram_bot start`
            
            ---
            **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** aarch64_cortex-a53 (Xiaomi AX3000T –∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ)  
            **–†–∞–∑–º–µ—Ä:** $(stat -c%s packages/${{ needs.build_package.outputs.package_file }} | numfmt --to=iec-i)B
          files: |
            packages/*.ipk
            packages/Packages
            packages/Packages.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}